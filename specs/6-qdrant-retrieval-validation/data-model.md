# Data Model: Qdrant Retrieval Pipeline Validation

## Entities

### Query
**Description**: User input text that is converted to a vector using Cohere embeddings for semantic search; contains the search intent and context related to book content
**Fields**:
- `id`: Unique identifier for the query
- `text`: The original query text from user
- `embedding`: Vector representation of the query text (generated by Cohere)
- `category`: Topic category for the query (e.g., "ROS2", "Gazebo", "Isaac", etc.)
- `expected_topics`: List of expected topics/relevant content
- `created_at`: Timestamp when query was created

### TextChunk
**Description**: Segments of book content that have been processed and stored as vectors in Qdrant Cloud using Cohere embeddings; represents a unit of retrievable information
**Fields**:
- `id`: Unique identifier for the chunk
- `content`: The actual text content of the chunk
- `vector`: Vector representation of the content (generated by Cohere)
- `metadata`: Dictionary containing source information
  - `url`: URL of the source document
  - `page_title`: Title of the page containing this content
  - `section`: Section name within the document
  - `source_file`: Original file name
  - `chunk_index`: Position of this chunk in the original document
- `created_at`: Timestamp when chunk was indexed

### QueryResult
**Description**: Result of a query against the Qdrant database, containing retrieved chunks and their similarity scores
**Fields**:
- `query_id`: Reference to the original query
- `retrieved_chunks`: List of TextChunk objects retrieved
- `similarity_scores`: List of similarity scores corresponding to each retrieved chunk
- `retrieval_time_ms`: Time taken to retrieve results in milliseconds
- `top_k`: Number of chunks requested
- `executed_at`: Timestamp when query was executed

### ValidationResult
**Description**: Evaluation of the relevance and accuracy of query results
**Fields**:
- `query_result_id`: Reference to the QueryResult being evaluated
- `precision_at_k`: Precision metric for the top-k results
- `recall_at_k`: Recall metric for the relevant results
- `relevance_score`: Overall relevance score (0-1 scale)
- `semantic_alignment`: Measure of semantic alignment between query and results
- `metadata_accuracy`: Boolean indicating if all metadata was correctly retrieved
- `evaluated_at`: Timestamp when evaluation was performed

### ValidationConfig
**Description**: Configuration parameters for the validation process
**Fields**:
- `top_k`: Number of results to retrieve for each query (default: 5)
- `cohere_model`: Name of the Cohere model to use for embeddings
- `qdrant_collection`: Name of the Qdrant collection to query
- `test_queries`: List of predefined test queries to use
- `validation_threshold`: Minimum relevance score for acceptable results
- `max_retries`: Maximum number of retry attempts for failed queries

## Relationships

```
Query --[1]--> QueryResult <--[1..n]-- TextChunk
QueryResult --[1]--> ValidationResult
ValidationConfig --[1]--> QueryResult (used during execution)
```

## Validation Rules

### Query Entity
- `text` must not be empty or exceed 2000 characters
- `category` must be one of predefined book topic categories
- `embedding` must be generated successfully using Cohere API

### TextChunk Entity
- `content` must not be empty
- `vector` must have the expected dimensionality for the Cohere model
- `metadata` must contain required fields (url, page_title, section)
- `metadata.url` must be a valid URL format

### QueryResult Entity
- `retrieved_chunks` length must equal `top_k` parameter
- `similarity_scores` must be between 0 and 1
- `retrieval_time_ms` must be positive
- `retrieved_chunks` must be unique (no duplicates)

### ValidationResult Entity
- `precision_at_k` must be between 0 and 1
- `recall_at_k` must be between 0 and 1
- `relevance_score` must be between 0 and 1
- `semantic_alignment` must be between 0 and 1

## State Transitions

### Query Processing Flow
```
CREATED -> EMBEDDING_GENERATED -> QUERY_EXECUTED -> RESULTS_EVALUATED
```

1. **CREATED**: Query is initialized with text and category
2. **EMBEDDING_GENERATED**: Cohere embedding has been created
3. **QUERY_EXECUTED**: Query has been sent to Qdrant and results retrieved
4. **RESULTS_EVALUATED**: Validation metrics have been calculated

### Validation Status Flow
```
PENDING -> IN_PROGRESS -> COMPLETED -> REPORTED
```

1. **PENDING**: Validation job is queued
2. **IN_PROGRESS**: Validation is currently running
3. **COMPLETED**: All validation metrics calculated
4. **REPORTED**: Results have been aggregated and reported